<!DOCTYPE html><html lang="en" class="no-js"><head><script type="text/javascript">document.documentElement.className = 'js'</script><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><link rel="icon" href="/favicon.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="default"/><meta name="theme-color" content="#fff"/><meta name="msapplication-navbutton-color" content="#fff"/><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="true"/><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&amp;family=Mulish:wght@500;900&amp;family=Montserrat:wght@500&amp;display=swap" data-optimized-fonts="true"/><link href="/fonts/cantarell/font.css" rel="stylesheet"/><title>NPM package deployment using YAML GitHub Actions | Jaxson Van Doorn</title><meta name="description" content="All-around developer, half-designer and tinkerer."/><meta property="og:title" content="NPM package deployment using YAML GitHub Actions"/><meta property="og:description" content="All-around developer, half-designer and tinkerer."/><meta property="og:type" content="website"/><meta property="og:image" content="https://og.jaxs.onl/**NPM package deployment using YAML GitHub Actions**.png?&amp;md=1&amp;images=https://og.jaxs.onl/jvd.png&amp;widths=300&amp;heights=300"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="Jaxson Van Doorn"/><meta name="twitter:title" content="NPM package deployment using YAML GitHub Actions"/><meta name="twitter:description" content="All-around developer, half-designer and tinkerer."/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="32x32" href="/icons/mask-32x32.png"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/mask-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/mask-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/mask-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/mask-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/mask-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/mask-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/mask-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/mask-512x512.png"/><meta name="next-head-count" content="30"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-b85bf5787457b580.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-456e88dfd5e7b8b9.js" defer=""></script><script src="/_next/static/chunks/pages/_app-84c755fde4efef7f.js" defer=""></script><script src="/_next/static/chunks/568-d2dcaee8b7ec1e6c.js" defer=""></script><script src="/_next/static/chunks/211-999bc0dfe193a869.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bpost%5D-dd2a15711e60f4fb.js" defer=""></script><script src="/_next/static/HbfhU_jTrClqZPqg3v2Hg/_buildManifest.js" defer=""></script><script src="/_next/static/HbfhU_jTrClqZPqg3v2Hg/_ssgManifest.js" defer=""></script><script src="/_next/static/HbfhU_jTrClqZPqg3v2Hg/_middlewareManifest.js" defer=""></script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&family=Mulish:wght@500;900&family=Montserrat:wght@500&display=swap"/></head><body><div id="__next"><div class="css-0" style="opacity:0"><style data-emotion="css h6z2sw">.css-h6z2sw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin:0 auto;padding:5px 0;width:93%;max-width:1200px;min-height:100%;box-sizing:border-box;}@media (min-width: 499px){.css-h6z2sw{width:90%;}}@media (min-width: 675px){.css-h6z2sw{width:90%;}}@media (min-width: 850px){.css-h6z2sw{width:750px;}}@media (min-width: 992px){.css-h6z2sw{width:920px;}}@media (min-width: 1200px){.css-h6z2sw{width:90%;}}@media (min-width: 1800px){.css-h6z2sw{width:90%;}}</style><div class="css-h6z2sw"><style data-emotion="css 1t3r034">.css-1t3r034{margin-top:30px;}</style><header class="css-1t3r034"><style data-emotion="css 1yxfang">.css-1yxfang{width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;}</style><nav class="css-1yxfang"><style data-emotion="css eh0twh">.css-eh0twh >div{width:87px;display:inline-block;border-radius:5px;background:linear-gradient(110deg, #fe7255 10%, #fe5f55);}.css-eh0twh >div>div{display:inline-block;border-radius:5px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;background:#fff;height:100%;font-family:'Mulish',sans-serif;letter-spacing:0.3px;line-height:18.5px;font-size:16px;font-weight:900;padding:10px;color:#5d5d5d;border:1px solid #ccc;-webkit-transition:background 0.7s cubic-bezier(0.04, 0.9, 0.48, 1.15) 0s;transition:background 0.7s cubic-bezier(0.04, 0.9, 0.48, 1.15) 0s;}.css-eh0twh >div>div:hover{background:rgba(0, 0, 0, 0);color:#fff;border:none;padding:11px;}.css-eh0twh >div>div >svg{margin-right:5px;}</style><style data-emotion="css 13mdudk">.css-13mdudk{-webkit-text-decoration:none;text-decoration:none;}.css-13mdudk >div{width:87px;display:inline-block;border-radius:5px;background:linear-gradient(110deg, #fe7255 10%, #fe5f55);}.css-13mdudk >div>div{display:inline-block;border-radius:5px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;background:#fff;height:100%;font-family:'Mulish',sans-serif;letter-spacing:0.3px;line-height:18.5px;font-size:16px;font-weight:900;padding:10px;color:#5d5d5d;border:1px solid #ccc;-webkit-transition:background 0.7s cubic-bezier(0.04, 0.9, 0.48, 1.15) 0s;transition:background 0.7s cubic-bezier(0.04, 0.9, 0.48, 1.15) 0s;}.css-13mdudk >div>div:hover{background:rgba(0, 0, 0, 0);color:#fff;border:none;padding:11px;}.css-13mdudk >div>div >svg{margin-right:5px;}</style><a aria-current="false" class="css-13mdudk" href="/blog/"><div><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="28px" width="28px" xmlns="http://www.w3.org/2000/svg"><path d="M401.4 224h-214l83-79.4c11.9-12.5 11.9-32.7 0-45.2s-31.2-12.5-43.2 0L89 233.4c-6 5.8-9 13.7-9 22.4v.4c0 8.7 3 16.6 9 22.4l138.1 134c12 12.5 31.3 12.5 43.2 0 11.9-12.5 11.9-32.7 0-45.2l-83-79.4h214c16.9 0 30.6-14.3 30.6-32 .1-18-13.6-32-30.5-32z"></path></svg>Back</div></div></a><style data-emotion="css 1mj39si">.css-1mj39si{--scale-logo:1;}@media only screen and (max-width: 1200px){.css-1mj39si{--scale-logo:1.2;}}@media only screen and (max-width: 675px){.css-1mj39si{--scale-logo:1.5;}}</style><style data-emotion="css pbkug5">.css-pbkug5{-webkit-text-decoration:none;text-decoration:none;--scale-logo:1;}@media only screen and (max-width: 1200px){.css-pbkug5{--scale-logo:1.2;}}@media only screen and (max-width: 675px){.css-pbkug5{--scale-logo:1.5;}}</style><a aria-current="false" class="css-pbkug5" href="/"><div class="css-0" style="opacity:0;transform:none"><style data-emotion="css fuqylt">.css-fuqylt{padding-left:calc(14px / var(--scale-logo));width:calc(224px / var(--scale-logo));height:calc(98px / var(--scale-logo));font-weight:700;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column-reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse;font-family:Cantarell,sans-serif;position:relative;}</style><div class="css-fuqylt"><style data-emotion="css 1ww0cn">.css-1ww0cn{position:absolute;bottom:calc(-10px / var(--scale-logo));font-size:calc(64px / var(--scale-logo));letter-spacing:calc(-1px / var(--scale-logo));z-index:10;color:#fe9c55;-webkit-transition:color 0.5s ease;transition:color 0.5s ease;font-weight:900;-webkit-transform:skew(172deg, 0deg);-moz-transform:skew(172deg, 0deg);-ms-transform:skew(172deg, 0deg);transform:skew(172deg, 0deg);}</style><div class="css-1ww0cn">Jaxson</div><style data-emotion="css x0un0y">.css-x0un0y{letter-spacing:calc(-2px / var(--scale-logo));font-size:calc(33px / var(--scale-logo));position:absolute;top:0;right:calc(13px / var(--scale-logo));z-index:5;font-weight:400;color:#d2d8e0;-webkit-align-self:flex-end;-ms-flex-item-align:flex-end;align-self:flex-end;text-transform:lowercase;}</style><div class="css-x0un0y" style="opacity:0;transform:translateY(50px) translateZ(0)"><span>Van</span><style data-emotion="css 38lglc">.css-38lglc{display:none;}</style><span class="css-38lglc"> </span><span>Door<style data-emotion="css slydap">.css-slydap{margin-left:1.25px;}</style><span class="css-slydap">n</span></span></div></div></div></a></nav></header></div></div><div class="css-0" style="opacity:0;transform:translateX(0px) translateY(-16px) translateZ(0)"><style data-emotion="css 2cgmis">.css-2cgmis{background:#fff;color:#000;}</style><div id="root-layout-wrapper" class="css-2cgmis"><style data-emotion="css-global 3fa1mh">.no-js *[style]{opacity:1!important;-webkit-transform:none!important;-moz-transform:none!important;-ms-transform:none!important;transform:none!important;}.no-js .slide-in{height:368px!important;}*{box-sizing:inherit;box-sizing:border-box;}body{margin:0;padding:0;}html,h1,h2,h3,h4,h5,h6,a,p{font-family:'Cabin',sans-serif;}p{margin:0 0 1.6rem;padding:0;}img{max-width:100%;margin:0;padding:0;border-radius:25px;}p img:first-of-type{margin-right:1.6rem;}p img:last-of-type{margin-right:0px;}a{display:inline-block;-webkit-text-decoration:none;text-decoration:none;color:#000;}ul{margin-left:1.6rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.6rem;list-style-position:outside;list-style-image:none;}li{padding-left:0;margin-bottom:0.8rem;}pre{margin:0;margin-bottom:1.6rem;font-size:0.85rem;line-height:1.42;overflow:auto;word-wrap:normal;padding:1.6rem;background:#2d2833;color:#fff;}pre[class*='language-']{background:#2d2833!important;font-size:0.95em!important;color:#aaaaca;}blockquote{padding:0 0 0 20px;margin:0 28px 28px 28px;border-left:4px solid #f27052;}blockquote *:last-of-type{margin:0;padding:0;}.hljs-comment{color:#787890;}.hljs-bullet{color:#8b8bb1;}.hljs-string{color:#dd672c;}.hljs-keyword,.hljs-name,.hljs-link{color:#fe8c52;}.hljs-attr{color:#aaaaca;}.language-yaml .hljs-attr{color:#fe8c52;}.language-yaml .hljs-string{color:#aaaaca;}::selection{background:rgba(0, 40, 255, 0.3)!important;color:#314cf0!important;}</style><main class="css-0"><style data-emotion="css h6z2sw">.css-h6z2sw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin:0 auto;padding:5px 0;width:93%;max-width:1200px;min-height:100%;box-sizing:border-box;}@media (min-width: 499px){.css-h6z2sw{width:90%;}}@media (min-width: 675px){.css-h6z2sw{width:90%;}}@media (min-width: 850px){.css-h6z2sw{width:750px;}}@media (min-width: 992px){.css-h6z2sw{width:920px;}}@media (min-width: 1200px){.css-h6z2sw{width:90%;}}@media (min-width: 1800px){.css-h6z2sw{width:90%;}}</style><div class="css-h6z2sw"><style data-emotion="css 1ch4sr4">.css-1ch4sr4{--scale-title:1;display:block;margin:0;color:#000;padding:20px 0;font-weight:900;font-family:'Mulish',sans-serif;-webkit-text-decoration:none;text-decoration:none;text-transform:none;-webkit-transform:none;-moz-transform:none;-ms-transform:none;transform:none;-webkit-transition:color 0.3s ease-in-out;transition:color 0.3s ease-in-out;width:unset;letter-spacing:calc(0.65px / var(--scale-title));font-size:calc(45px / var(--scale-title));line-height:calc(40px / var(--scale-title));}@media only screen and (max-width: 1200px){.css-1ch4sr4{--scale-title:1.2;}}@media only screen and (max-width: 675px){.css-1ch4sr4{--scale-title:1.5;}}.css-1ch4sr4[aria-current='page']{color:#27292b;}</style><h1 class="css-1ch4sr4">NPM package deployment using YAML GitHub Actions</h1><style data-emotion="css 4fr7nj">.css-4fr7nj h1:first-of-type{display:none;}</style><div class="css-4fr7nj"><div><h1 id="npm-package-deployment-using-yaml-github-actions">NPM package deployment using YAML GitHub Actions</h1>
<p>Recently <style data-emotion="css zyvd1d">.css-zyvd1d{padding:4px 8px;background:#fe9f5a;border-radius:7px;border:25px;margin:2px 2px;font-weight:900;color:#fff;}</style><style data-emotion="css 4facr5">.css-4facr5{-webkit-text-decoration:none;text-decoration:none;padding:4px 8px;background:#fe9f5a;border-radius:7px;border:25px;margin:2px 2px;font-weight:900;color:#fff;}</style><a class="css-4facr5" href="http://github.com">GitHub</a> announced that <a class="css-4facr5" href="https://github.com/features/actions">GitHub Actions</a> will be <a class="css-4facr5" href="https://github.blog/2019-08-08-github-actions-now-supports-ci-cd/">moving away</a> from the original <a class="css-4facr5" href="https://github.com/hashicorp/hcl">HCL</a> syntax in-favour of a <a class="css-4facr5" href="https://yaml.org/">YAML</a> format
similar to <a class="css-4facr5" href="https://travis-ci.org/">Travis CI</a> and <a class="css-4facr5" href="https://bitbucket.org/product/features/pipelines">Bitbucket Pipelines</a>.  This means that <a class="css-4facr5" href="https://github.com/hashicorp/hcl">HCL</a> style actions will no longer work <a class="css-4facr5" href="https://developer.github.com/actions/">after September 30, 2019</a>.  It is possible to migrate using a <a class="css-4facr5" href="https://help.github.com/en/articles/migrating-github-actions-from-hcl-syntax-to-yaml-syntax">migration script</a> however in-some cases it may be required to reconfigure.</p>
<p>This particular issue occurred to me as actions which return a neutral result seem to fail the whole build with the <a class="css-4facr5" href="https://yaml.org/">YAML</a> format.  This means that using <a class="css-4facr5" href="https://github.com/actions/bin/tree/master/filter/bin">actions/bin/filter</a> to trigger a deploy would fail the build unless a release tag was found.  With this in mind, reconfiguring my <a class="css-4facr5" href="https://github.com/features/actions">GitHub Actions</a> seemed like the best choice.</p>
<p></p>
<h2 id="desired-behaviour">Desired Behaviour</h2>
<p>My particular use of <a class="css-4facr5" href="https://github.com/features/actions">GitHub Actions</a> is for deploying my small <a class="css-4facr5" href="https://docs.npmjs.com/creating-node-js-modules">NPM packages</a>.</p>
<p>To keep it simple I wanted the following to occur:</p>
<ul>
<li>Install dependencies, Build and Test package on each commit</li>
<li>Publish package if a release tag was created</li>
</ul>
<p></p>
<h2 id="creating-the-action-configuration">Creating the Action Configuration</h2>
<p>Create the file <code>.github/workflows/workflow.yml</code></p>
<p></p>
<h3 id="checking-for-tag">Checking for Tag</h3>
<p>This method simply builds and tests the package on any commit.</p>
<p>Then if it finds a tag starting with <strong>v</strong>, it will trigger a deploy.</p>
<p>So if a <a class="css-4facr5" href="https://help.github.com/en/articles/creating-releases">GitHub Release</a> is created with the tag <strong>v2.3.4</strong>, it will trigger a deploy.</p>
<p>This is a bit naive however for my purposes I usually don&#x27;t tag unless its a release.</p>
<p>One advantage of checking for a tag this way is that it cuts down on unneeded builds as a whole build can only ever run 1 or 2 times (2 in the case a build is deployed).</p>
<p>The <a class="css-4facr5" href="https://github.com/features/actions">GitHub Actions</a> docs mentions being able to <a class="css-4facr5" href="https://help.github.com/en/articles/workflow-syntax-for-github-actions#example-restricting-the-workflow-run-to-specific-refs-and-paths">restrict actions</a> to certain branches or tags however I could not get this to work.</p>
<pre><code class="hljs language-yaml css-0">name: build # Name Action Build

on: [push]  # Trigger on push

jobs:
  run:
    runs-on: ubuntu-latest                         # Run on Ubuntu Docker image
    steps:
    - name: Checkout Repo                          # Checkout repo
      uses: actions/checkout@v1
    - name: Use Node.js                            # Configure Node.js
      uses: actions/setup-node@v1
      with:
        node-version: <span class="hljs-string">'12.9'</span>                       # Set Node.js Version
        registry-url: <span class="hljs-string">'https://registry.npmjs.org'</span> # Set Node.js reigistry
    - name: Deploy Info                            # Print GitHub Deploy info
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo <span class="hljs-string">"$GITHUB_CONTEXT"</span>
    - name: Install                                # Install dependancies
      run: npm install
    - name: Build                                  # Build app <span class="hljs-keyword">if</span> needed
      run: npm run build --<span class="hljs-keyword">if</span>-present
    - name: Test
      run: npm run test --<span class="hljs-keyword">if</span>-present               # Run tests <span class="hljs-keyword">if</span> needed
    - name: Publish
      <span class="hljs-keyword">if</span>: startsWith(github.ref, <span class="hljs-string">'refs/tags/v'</span>)    # Check <span class="hljs-keyword">if</span> publish step should run
      run: npm publish --access public             # Publish package
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }} # Set NPM auth token from GitHub Secrets
</code></pre>
<p></p>
<h3 id="checking-for-a-release">Checking for a Release</h3>
<p>If you found the previous method too naive, you may want to check for a <a class="css-4facr5" href="https://help.github.com/en/articles/creating-releases">GitHub Release</a> before triggering a deploy.</p>
<p>The drawback to this is that a few extraneous builds will be triggered as the <code>release</code> event will fire both when the release is <code>created</code> and <code>published</code>.  As far as I am aware this can not be restricted using the <code>on</code> property.</p>
<p>To ensure we only deploy once, we will indicate to only run the <strong>Publish</strong> step when a release is <code>published</code>.</p>
<pre><code class="hljs language-yaml css-0">name: build

on:
  push:     # Run build on <span class="hljs-title hljs-function">push</span> <span class="hljs-params">(commit in most cases)</span>
    tag: [] # Only run build <span class="hljs-keyword">if</span> not tagged
  release:  # Run build on release
    tag:
    - v*    # Check <span class="hljs-keyword">for</span> release tag

jobs:
  run:
    runs-on: ubuntu-latest                         # Run on Ubuntu Docker image
    steps:
    - name: Checkout Repo                          # Checkout repo
      uses: actions/checkout@v1
    - name: Use Node.js                            # Configure Node.js
      uses: actions/setup-node@v1
      with:
        node-version: '12.9'                       # Set Node.js Version
        registry-url: 'https:<span class="hljs-comment">//registry.npmjs.org' # Set Node.js reigistry</span>
    - name: Deploy Info                            # Print GitHub Deploy info
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo <span class="hljs-string">"$GITHUB_CONTEXT"</span>
    - name: Install                                # Install dependancies
      run: npm install
    - name: Build                                  # Build app <span class="hljs-keyword">if</span> needed
      run: npm run build --<span class="hljs-keyword">if</span>-present
    - name: Test
      run: npm run test --<span class="hljs-keyword">if</span>-present               # Run tests <span class="hljs-keyword">if</span> needed
    - name: Publish
      <span class="hljs-keyword">if</span>: github.event_name == <span class="hljs-string">'release'</span> &#x26;&#x26; github.event.action == <span class="hljs-string">'published'</span> # Check <span class="hljs-keyword">if</span> publish step should run
      run: npm publish --access public             # Publish package
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }} # Set NPM auth token from GitHub Secrets
</code></pre>
<p></p>
<h2 id="setting-npm-auth-token-secret">Setting NPM Auth Token Secret</h2>
<p>Simply go to your repo <strong>Settings</strong> and select the <strong>Secrets</strong> tab.</p>
<p>Then <strong>Add a new secret</strong> with the <strong>Name</strong> of <code>NPM_AUTH_TOKEN</code> and set the <strong>Value</strong> to your <a class="css-4facr5" href="https://docs.npmjs.com/creating-and-viewing-authentication-tokens">NPM token</a>.</p>
<p></p>
<h2 id="adding-the-github-actions-badge">Adding the GitHub Actions badge</h2>
<p><a class="css-4facr5" href="http://github.com">GitHub</a> now offers an undocumented API which will return nice <a class="css-4facr5" href="https://travis-ci.org/">Travis CI</a> like status badge.</p>
<p>An example can be seen on the <a class="css-4facr5" href="https://github.com/actions/toolkit">actions/toolkit</a> repo.</p>
<p>The format for the API is as follows:</p>
<pre><code class="hljs language-markdown css-0">https:<span class="hljs-comment">//github.com/&#x3C;user|org>/&#x3C;repo>/&#x3C;action_name>/badge.svg</span>
</code></pre>
<p>The <code>action_name</code> propery is the <code>name</code> field in the <a class="css-4facr5" href="https://yaml.org/">YAML</a> which in this case is <code>build</code>.</p>
<p>An example of this would be:</p>
<pre><code class="hljs language-markdown css-0">https:<span class="hljs-comment">//github.com/woofers/ludum-dare-badges/workflows/build/badge.svg</span>
</code></pre>
<p>To make it even nicer we can link the badge to our repo&#x27;s actions page:</p>
<pre><code class="hljs language-markdown css-0">[![img](https:<span class="hljs-comment">//github.com/woofers/ludum-dare-badges/workflows/build/badge.svg)](https://github.com/woofers/ludum-dare-badges/actions)</span>
</code></pre>
<p>It will look something like this:</p>
<p><a class="css-4facr5" href="https://github.com/woofers/ludum-dare-badges/actions"><img src="https://github.com/woofers/ludum-dare-badges/workflows/build/badge.svg" alt="img"/></a></p></div></div></div></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"content":"---\nlayout: post\ntitle: NPM package deployment using YAML GitHub Actions\ndate: 2019-08-21\n---\n\n# NPM package deployment using YAML GitHub Actions\n\nRecently [GitHub](http://github.com) announced that [GitHub Actions](https://github.com/features/actions) will be [moving away](https://github.blog/2019-08-08-github-actions-now-supports-ci-cd/) from the original [HCL](https://github.com/hashicorp/hcl) syntax in-favour of a [YAML](https://yaml.org/) format\nsimilar to [Travis CI](https://travis-ci.org/) and [Bitbucket Pipelines](https://bitbucket.org/product/features/pipelines).  This means that [HCL](https://github.com/hashicorp/hcl) style actions will no longer work [after September 30, 2019](https://developer.github.com/actions/).  It is possible to migrate using a [migration script](https://help.github.com/en/articles/migrating-github-actions-from-hcl-syntax-to-yaml-syntax) however in-some cases it may be required to reconfigure.\n\nThis particular issue occurred to me as actions which return a neutral result seem to fail the whole build with the [YAML](https://yaml.org/) format.  This means that using [actions/bin/filter](https://github.com/actions/bin/tree/master/filter/bin) to trigger a deploy would fail the build unless a release tag was found.  With this in mind, reconfiguring my [GitHub Actions](https://github.com/features/actions) seemed like the best choice.\n\n\n\u003ca id=\"orgb58448b\"\u003e\u003c/a\u003e\n\n## Desired Behaviour\n\nMy particular use of [GitHub Actions](https://github.com/features/actions) is for deploying my small [NPM packages](https://docs.npmjs.com/creating-node-js-modules).\n\nTo keep it simple I wanted the following to occur:\n\n-   Install dependencies, Build and Test package on each commit\n-   Publish package if a release tag was created\n\n\n\u003ca id=\"org521573d\"\u003e\u003c/a\u003e\n\n## Creating the Action Configuration\n\nCreate the file `.github/workflows/workflow.yml`\n\n\n\u003ca id=\"org9bc8afb\"\u003e\u003c/a\u003e\n\n### Checking for Tag\n\nThis method simply builds and tests the package on any commit.\n\nThen if it finds a tag starting with **v**, it will trigger a deploy.\n\nSo if a [GitHub Release](https://help.github.com/en/articles/creating-releases) is created with the tag **v2.3.4**, it will trigger a deploy.\n\nThis is a bit naive however for my purposes I usually don't tag unless its a release.\n\nOne advantage of checking for a tag this way is that it cuts down on unneeded builds as a whole build can only ever run 1 or 2 times (2 in the case a build is deployed).\n\nThe [GitHub Actions](https://github.com/features/actions) docs mentions being able to [restrict actions](https://help.github.com/en/articles/workflow-syntax-for-github-actions#example-restricting-the-workflow-run-to-specific-refs-and-paths) to certain branches or tags however I could not get this to work.\n\n```yaml\nname: build # Name Action Build\n\non: [push]  # Trigger on push\n\njobs:\n  run:\n    runs-on: ubuntu-latest                         # Run on Ubuntu Docker image\n    steps:\n    - name: Checkout Repo                          # Checkout repo\n      uses: actions/checkout@v1\n    - name: Use Node.js                            # Configure Node.js\n      uses: actions/setup-node@v1\n      with:\n        node-version: '12.9'                       # Set Node.js Version\n        registry-url: 'https://registry.npmjs.org' # Set Node.js reigistry\n    - name: Deploy Info                            # Print GitHub Deploy info\n      env:\n        GITHUB_CONTEXT: ${{ toJson(github) }}\n      run: echo \"$GITHUB_CONTEXT\"\n    - name: Install                                # Install dependancies\n      run: npm install\n    - name: Build                                  # Build app if needed\n      run: npm run build --if-present\n    - name: Test\n      run: npm run test --if-present               # Run tests if needed\n    - name: Publish\n      if: startsWith(github.ref, 'refs/tags/v')    # Check if publish step should run\n      run: npm publish --access public             # Publish package\n      env:\n        NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }} # Set NPM auth token from GitHub Secrets\n```\n\n\n\u003ca id=\"org2d248b4\"\u003e\u003c/a\u003e\n\n### Checking for a Release\n\nIf you found the previous method too naive, you may want to check for a [GitHub Release](https://help.github.com/en/articles/creating-releases) before triggering a deploy.\n\nThe drawback to this is that a few extraneous builds will be triggered as the `release` event will fire both when the release is `created` and `published`.  As far as I am aware this can not be restricted using the `on` property.\n\nTo ensure we only deploy once, we will indicate to only run the **Publish** step when a release is `published`.\n\n```yaml\nname: build\n\non:\n  push:     # Run build on push (commit in most cases)\n    tag: [] # Only run build if not tagged\n  release:  # Run build on release\n    tag:\n    - v*    # Check for release tag\n\njobs:\n  run:\n    runs-on: ubuntu-latest                         # Run on Ubuntu Docker image\n    steps:\n    - name: Checkout Repo                          # Checkout repo\n      uses: actions/checkout@v1\n    - name: Use Node.js                            # Configure Node.js\n      uses: actions/setup-node@v1\n      with:\n        node-version: '12.9'                       # Set Node.js Version\n        registry-url: 'https://registry.npmjs.org' # Set Node.js reigistry\n    - name: Deploy Info                            # Print GitHub Deploy info\n      env:\n        GITHUB_CONTEXT: ${{ toJson(github) }}\n      run: echo \"$GITHUB_CONTEXT\"\n    - name: Install                                # Install dependancies\n      run: npm install\n    - name: Build                                  # Build app if needed\n      run: npm run build --if-present\n    - name: Test\n      run: npm run test --if-present               # Run tests if needed\n    - name: Publish\n      if: github.event_name == 'release' \u0026\u0026 github.event.action == 'published' # Check if publish step should run\n      run: npm publish --access public             # Publish package\n      env:\n        NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }} # Set NPM auth token from GitHub Secrets\n```\n\n\n\u003ca id=\"org515fedd\"\u003e\u003c/a\u003e\n\n## Setting NPM Auth Token Secret\n\nSimply go to your repo **Settings** and select the **Secrets** tab.\n\nThen **Add a new secret** with the **Name** of `NPM_AUTH_TOKEN` and set the **Value** to your [NPM token](https://docs.npmjs.com/creating-and-viewing-authentication-tokens).\n\n\n\u003ca id=\"org5d470fc\"\u003e\u003c/a\u003e\n\n## Adding the GitHub Actions badge\n\n[GitHub](http://github.com) now offers an undocumented API which will return nice [Travis CI](https://travis-ci.org/) like status badge.\n\nAn example can be seen on the [actions/toolkit](https://github.com/actions/toolkit) repo.\n\nThe format for the API is as follows:\n\n```markdown\nhttps://github.com/\u003cuser|org\u003e/\u003crepo\u003e/\u003caction_name\u003e/badge.svg\n```\n\nThe `action_name` propery is the `name` field in the [YAML](https://yaml.org/) which in this case is `build`.\n\nAn example of this would be:\n\n```markdown\nhttps://github.com/woofers/ludum-dare-badges/workflows/build/badge.svg\n```\n\nTo make it even nicer we can link the badge to our repo's actions page:\n\n```markdown\n[![img](https://github.com/woofers/ludum-dare-badges/workflows/build/badge.svg)](https://github.com/woofers/ludum-dare-badges/actions)\n```\n\nIt will look something like this:\n\n[![img](https://github.com/woofers/ludum-dare-badges/workflows/build/badge.svg)](https://github.com/woofers/ludum-dare-badges/actions)\n","date":"","post":"yaml-github-actions"}},"__N_SSG":true},"page":"/blog/[post]","query":{"post":"yaml-github-actions"},"buildId":"HbfhU_jTrClqZPqg3v2Hg","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>