{"componentChunkName":"component---src-templates-post-js","path":"/blog/yaml-github-actions/","result":{"data":{"site":{"siteMetadata":{"social":{"github":{"name":"GitHub","link":"//github.com/woofers"},"stackoverflow":{"name":"Stack Overflow","link":"//stackoverflow.com/users/9129020/jvandoorn"},"twitter":{"name":"Twitter","link":"//twitter.com/jaxsonvandoorn","handle":"@jaxsonvandoorn"},"linkedin":{"name":"LinkedIn","link":"//www.linkedin.com/in/jaxson-van-doorn/"},"email":{"name":"Email","link":"mailto:jaxson.vandoorn@gmail.com"}}}},"orgContent":{"html":"<p>Recently <a href=\"http://github.com\">GitHub</a> announced that <a href=\"https://github.com/features/actions\">GitHub Actions</a> will be <a href=\"https://github.blog/2019-08-08-github-actions-now-supports-ci-cd/\">moving away</a> from the original <a href=\"https://github.com/hashicorp/hcl\">HCL</a> syntax in-favour of a <a href=\"https://yaml.org/\">YAML</a> format similar to <a href=\"https://travis-ci.org/\">Travis CI</a> and <a href=\"https://bitbucket.org/product/features/pipelines\">Bitbucket Pipelines</a>.  This means that <a href=\"https://github.com/hashicorp/hcl\">HCL</a> style actions will no longer work <a href=\"https://developer.github.com/actions/\">after September 30, 2019</a>.  It is possible to migrate using a <a href=\"https://help.github.com/en/articles/migrating-github-actions-from-hcl-syntax-to-yaml-syntax\">migration script</a> however in-some cases it may be required to reconfigure.</p><p>This particular issue occurred to me as actions which return a neutral result seem to fail the whole build with the <a href=\"https://yaml.org/\">YAML</a> format.  This means that using <a href=\"https://github.com/actions/bin/tree/master/filter/bin\">actions/bin/filter</a> to trigger a deploy would fail the build unless a release tag was found.  With this in mind, reconfiguring my <a href=\"https://github.com/features/actions\">GitHub Actions</a> seemed like the best choice.</p><div class=\"section\"><h1>Desired Behaviour</h1><p>My particular use of <a href=\"https://github.com/features/actions\">GitHub Actions</a> is for deploying my small <a href=\"https://docs.npmjs.com/creating-node-js-modules\">NPM packages</a>.</p><p>To keep it simple I wanted the following to occur:</p><ul><li>Install dependencies, Build and Test package on each commit</li><li>Publish package if a release tag was created</li></ul></div><div class=\"section\"><h1>Creating the Action Configuration</h1><p>Create the file <code>.github/workflows/workflow.yml</code></p><div class=\"section\"><h2>Checking for Tag</h2><p>This method simply builds and tests the package on any commit.</p><p>Then if it finds a tag starting with <strong>v</strong>, it will trigger a deploy.</p><p>So if a <a href=\"https://help.github.com/en/articles/creating-releases\">GitHub Release</a> is created with the tag <strong>v2.3.4</strong>, it will trigger a deploy.</p><p>This is a bit naive however for my purposes I usually don't tag unless its a release.</p><p>One advantage of checking for a tag this way is that it cuts down on unneeded builds as a whole build can only ever run 1 or 2 times (2 in the case a build is deployed).</p><p>The <a href=\"https://github.com/features/actions\">GitHub Actions</a> docs mentions being able to <a href=\"https://help.github.com/en/articles/workflow-syntax-for-github-actions#example-restricting-the-workflow-run-to-specific-refs-and-paths\">restrict actions</a> to certain branches or tags however I could not get this to work.</p><pre><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build <span class=\"token comment\"># Name Action Build</span>\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>push<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># Trigger on push</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest                         <span class=\"token comment\"># Run on Ubuntu Docker image</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout Repo                          <span class=\"token comment\"># Checkout repo</span>\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Use Node.js                            <span class=\"token comment\"># Configure Node.js</span>\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'12.9'</span>                       <span class=\"token comment\"># Set Node.js Version</span>\n        <span class=\"token key atrule\">registry-url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://registry.npmjs.org'</span> <span class=\"token comment\"># Set Node.js reigistry</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy Info                            <span class=\"token comment\"># Print GitHub Deploy info</span>\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">GITHUB_CONTEXT</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> toJson(github) <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo \"$GITHUB_CONTEXT\"\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install                                <span class=\"token comment\"># Install dependancies</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build                                  <span class=\"token comment\"># Build app if needed</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>if<span class=\"token punctuation\">-</span>present\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Test\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run test <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>if<span class=\"token punctuation\">-</span>present               <span class=\"token comment\"># Run tests if needed</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Publish\n      <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> startsWith(github.ref<span class=\"token punctuation\">,</span> 'refs/tags/v')    <span class=\"token comment\"># Check if publish step should run</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm publish <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>access public             <span class=\"token comment\"># Publish package</span>\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">NODE_AUTH_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NPM_AUTH_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># Set NPM auth token from GitHub Secrets</span></code></pre></div><div class=\"section\"><h2>Checking for a Release</h2><p>If you found the previous method too naive, you may want to check for a <a href=\"https://help.github.com/en/articles/creating-releases\">GitHub Release</a> before triggering a deploy.</p><p>The drawback to this is that a few extraneous builds will be triggered as the <code>release</code> event will fire both when the release is <code>created</code> and <code>published</code>.  As far as I am aware this can not be restricted using the <code>on</code> property.</p><p>To ensure we only deploy once, we will indicate to only run the <strong>Publish</strong> step when a release is <code>published</code>.</p><pre><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>     <span class=\"token comment\"># Run build on push (commit in most cases)</span>\n    <span class=\"token key atrule\">tag</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># Only run build if not tagged</span>\n  <span class=\"token key atrule\">release</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># Run build on release</span>\n    <span class=\"token key atrule\">tag</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> v*    <span class=\"token comment\"># Check for release tag</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest                         <span class=\"token comment\"># Run on Ubuntu Docker image</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout Repo                          <span class=\"token comment\"># Checkout repo</span>\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Use Node.js                            <span class=\"token comment\"># Configure Node.js</span>\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'12.9'</span>                       <span class=\"token comment\"># Set Node.js Version</span>\n        <span class=\"token key atrule\">registry-url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://registry.npmjs.org'</span> <span class=\"token comment\"># Set Node.js reigistry</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy Info                            <span class=\"token comment\"># Print GitHub Deploy info</span>\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">GITHUB_CONTEXT</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> toJson(github) <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> echo \"$GITHUB_CONTEXT\"\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install                                <span class=\"token comment\"># Install dependancies</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build                                  <span class=\"token comment\"># Build app if needed</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>if<span class=\"token punctuation\">-</span>present\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Test\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run test <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>if<span class=\"token punctuation\">-</span>present               <span class=\"token comment\"># Run tests if needed</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Publish\n      <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> github.event_name == 'release' &amp;&amp; github.event.action == 'published' <span class=\"token comment\"># Check if publish step should run</span>\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm publish <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>access public             <span class=\"token comment\"># Publish package</span>\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">NODE_AUTH_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NPM_AUTH_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token comment\"># Set NPM auth token from GitHub Secrets</span></code></pre></div></div><div class=\"section\"><h1>Setting NPM Auth Token Secret</h1><p>Simply go to your repo <strong>Settings</strong> and select the <strong>Secrets</strong> tab.</p><p>Then <strong>Add a new secret</strong> with the <strong>Name</strong> of <code>NPM_AUTH_TOKEN</code> and set the <strong>Value</strong> to your <a href=\"https://docs.npmjs.com/creating-and-viewing-authentication-tokens\">NPM token</a>.</p></div><div class=\"section\"><h1>Adding the GitHub Actions badge</h1><p><a href=\"http://github.com\">GitHub</a> now offers an undocumented API which will return nice <a href=\"https://travis-ci.org/\">Travis CI</a> like status badge.</p><p>An example can be seen on the <a href=\"https://github.com/actions/toolkit\">actions/toolkit</a> repo.</p><p>The format for the API is as follows:</p><pre><code class=\"language-bash\">https://github.com/<span class=\"token operator\">&lt;</span>user<span class=\"token operator\">|</span>org<span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>repo<span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>action_name<span class=\"token operator\">></span>/badge.svg</code></pre><p>The <code>action_name</code> propery is the <code>name</code> field in the <a href=\"https://yaml.org/\">YAML</a> which in this case is <code>build</code>.</p><p>An example of this would be:</p><pre><code class=\"language-bash\">https://github.com/woofers/ludum-dare-badges/workflows/build/badge.svg</code></pre><p>To make it even nicer we can link the badge to our repo's actions page:</p><pre><code class=\"language-markdown\"><span class=\"token url\">[<span class=\"token content\">![img</span>](https://github.com/woofers/ludum-dare-badges/workflows/build/badge.svg)</span>](https://github.com/woofers/ludum-dare-badges/actions)</code></pre><p>It will look something like this:</p><a style=\"color: rgba(0,0,0,0)\" href=\"https://github.com/woofers/ludum-dare-badges/actions\">\n  <img style=\"border-radius: 0\" src=\"https://github.com/woofers/ludum-dare-badges/workflows/build/badge.svg\" />\n</a></div>","metadata":{"title":"NPM package deployment using YAML GitHub Actions","date":"August 21, 2019","icon":null,"type":null,"icon_mode":null,"icon_type":null,"ludum_dare":null,"placeholder":null,"game":null,"landscape":null,"lang":null},"fields":{"slug":"/blog/yaml-github-actions/"}}},"pageContext":{"slug":"/blog/yaml-github-actions/"}},"staticQueryHashes":["2033956373","3784074786"]}